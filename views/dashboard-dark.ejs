<!-- 🎛️ واجهة الفلاتر التفاعلية ضمن لوحة التحكم -->
<div class="card card-dark p-4 mb-4">
  <h5 class="mb-3"><i class="bi bi-funnel"></i> فلاتر التقارير</h5>
  <form id="filterForm" class="row g-3">
    <div class="col-md-3">
      <label for="organizationFilter" class="form-label">المنظمة</label>
      <select id="organizationFilter" class="form-select">
        <option value="">الكل</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="organizationCodeFilter" class="form-label">كود المنظمة</label>
      <input type="text" id="organizationCodeFilter" class="form-control" placeholder="مثال: ORG-1">
    </div>
    <div class="col-md-3">
      <label for="ageGroupFilter" class="form-label">الفئة العمرية</label>
      <select id="ageGroupFilter" class="form-select">
        <option value="">الكل</option>
        <option value="(6-12 سنة)">(6-12 سنة)</option>
        <option value="(13-18 سنة)">(13-18 سنة)</option>
        <option value="(فوق 18 سنة)">(فوق 18 سنة)</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="trainingFilter" class="form-label">تلقى تدريبًا سابقًا</label>
      <select id="trainingFilter" class="form-select">
        <option value="">الكل</option>
        <option value="نعم">نعم</option>
        <option value="لا">لا</option>
      </select>
    </div>
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-outline-light"><i class="bi bi-funnel"></i> تطبيق الفلاتر</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("filterForm");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      applyFilters();
    });
  });

  async function applyFilters() {
    const res = await fetch('/api/survey-data');
    const data = await res.json();

    const org = document.getElementById("organizationFilter").value.trim();
    const code = document.getElementById("organizationCodeFilter").value.trim();
    const age = document.getElementById("ageGroupFilter").value;
    const training = document.getElementById("trainingFilter").value;

    let filtered = data.filter(row => {
      return (!org || row.organization === org) &&
             (!code || row.organizationCode?.toLowerCase().includes(code.toLowerCase())) &&
             (!age || row.ageGroups?.includes(age)) &&
             (!training || row.previousTraining === training);
    });

    console.log("🔎 بيانات بعد التصفية:", filtered);
    updateGeneralStatistics(filtered);
    drawDomainsChart(filtered);
  }
</script>
